name: EDUPLATFORM CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        echo "Python dependencies installed"
    
    - name: Run basic import tests
      run: |
        cd backend
        echo "Running basic import tests..."
        python -c "
        try:
            import app.models
            import app.schemas
            import app.crud
            from app.models import User, Course
            from app.schemas import UserCreate, CourseCreate
            print('All basic imports work correctly')
        except Exception as e:
            print(f'Import test failed: {e}')
            exit(1)
        "
    
    - name: Build and Test Backend Docker image
      run: |
        cd backend
        docker build -t eduplatform-backend:ci .
        echo "Testing Backend image..."
        docker run --rm eduplatform-backend:ci python -c "import sys; print('Testing imports...'); import app.models; import app.schemas; import app.crud; from app.models import User, Course; from app.schemas import UserCreate, CourseCreate; print('All imports successful'); print('Backend image test PASSED')"
        echo "Backend Docker image built and tested"
    
    - name: Build and Test Frontend Docker image
      run: |
        cd frontend
        docker build -t eduplatform-frontend:ci .
        echo "Frontend Docker image built"

  deploy:
    needs: test
    runs-on: self-hosted
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create k3d cluster
      shell: powershell
      run: |
        Write-Host "üîß Creating k3d cluster..." -ForegroundColor Green
        k3d cluster create eduplatform `
          --port "80:30080@loadbalancer" `
          --port "8000:30800@loadbalancer" `
          --agents 2
        Write-Host "‚úÖ k3d cluster created" -ForegroundColor Green
    
    - name: Build Docker images
      shell: powershell
      run: |
        Write-Host "üê≥ Building Docker images..." -ForegroundColor Green
        
        Write-Host "Building backend..." -ForegroundColor Cyan
        cd backend
        docker build -t eduplatform-backend:latest .
        
        Write-Host "Building frontend..." -ForegroundColor Cyan
        cd ../frontend
        docker build -t eduplatform-frontend:latest .
        
        Write-Host "‚úÖ Docker images built" -ForegroundColor Green
    
    - name: Import images to k3d
      shell: powershell
      run: |
        Write-Host "üì¶ Importing images to k3d cluster..." -ForegroundColor Green
        k3d image import eduplatform-backend:latest -c eduplatform
        k3d image import eduplatform-frontend:latest -c eduplatform
        Write-Host "‚úÖ Images imported" -ForegroundColor Green
    
    - name: Deploy infrastructure
      shell: powershell
      run: |
        Write-Host "üèóÔ∏è Deploying infrastructure..." -ForegroundColor Green
        
        Write-Host "Creating namespace..." -ForegroundColor Cyan
        kubectl apply -f k8s/namespace.yaml
        
        Write-Host "Deploying config..." -ForegroundColor Cyan
        kubectl apply -f k8s/configmap.yaml
        
        Write-Host "Deploying database..." -ForegroundColor Cyan
        kubectl apply -f k8s/postgresql.yaml
        kubectl apply -f k8s/redis.yaml
        
        Write-Host "‚úÖ Infrastructure deployed" -ForegroundColor Green
    
    - name: Wait for database
      shell: powershell
      run: |
        Write-Host "‚è≥ Waiting for database to be ready..." -ForegroundColor Yellow
        kubectl wait --for=condition=ready pod -l app=postgresql -n eduplatform --timeout=180s
        Write-Host "‚úÖ Database is ready" -ForegroundColor Green
    
    - name: Deploy applications
      shell: powershell
      run: |
        Write-Host "üöÄ Deploying applications..." -ForegroundColor Green
        
        Write-Host "Deploying backend API..." -ForegroundColor Cyan
        kubectl apply -f k8s/backend-api.yaml
        
        Write-Host "Deploying frontend..." -ForegroundColor Cyan
        kubectl apply -f k8s/frontend.yaml
        
        Write-Host "Deploying ingress..." -ForegroundColor Cyan
        kubectl apply -f k8s/ingress.yaml
        
        Write-Host "‚úÖ Applications deployed" -ForegroundColor Green
    
    - name: Wait for applications
      shell: powershell
      run: |
        Write-Host "‚è≥ Waiting for applications to be ready..." -ForegroundColor Yellow
        
        Write-Host "Waiting for backend..." -ForegroundColor Cyan
        kubectl wait --for=condition=ready pod -l app=backend-api -n eduplatform --timeout=300s
        
        Write-Host "Waiting for frontend..." -ForegroundColor Cyan
        kubectl wait --for=condition=ready pod -l app=frontend -n eduplatform --timeout=180s
        
        Write-Host "‚úÖ All applications are ready" -ForegroundColor Green
    
    - name: Run health checks
      shell: powershell
      run: |
        Write-Host "üîç Running health checks..." -ForegroundColor Green
        
        Write-Host "Checking backend health..." -ForegroundColor Cyan
        $maxRetries = 10
        $retryCount = 0
        
        while ($retryCount -lt $maxRetries) {
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:8000/health" -TimeoutSec 5 -UseBasicParsing
            if ($response.StatusCode -eq 200) {
              Write-Host "‚úÖ Backend health check passed" -ForegroundColor Green
              break
            }
          } catch {
            Write-Host "‚è≥ Backend not ready yet... ($($retryCount + 1)/$maxRetries)" -ForegroundColor Yellow
            Start-Sleep -Seconds 5
          }
          $retryCount++
        }
        
        if ($retryCount -eq $maxRetries) {
          Write-Host "‚ùå Backend health check failed" -ForegroundColor Red
          exit 1
        }
        
        Write-Host "‚úÖ All health checks passed" -ForegroundColor Green
    
    - name: Display deployment info
      shell: powershell
      run: |
        Write-Host "" -ForegroundColor White
        Write-Host "üéâ DEPLOYMENT SUCCESSFUL!" -ForegroundColor Green
        Write-Host "==========================================" -ForegroundColor Cyan
        Write-Host "üåê Frontend:     http://localhost:8080" -ForegroundColor White
        Write-Host "üîß Backend API:  http://localhost:8000" -ForegroundColor White
        Write-Host "üìö API Docs:     http://localhost:8000/docs" -ForegroundColor White
        Write-Host "‚ù§Ô∏è  Health Check: http://localhost:8000/health" -ForegroundColor White
        Write-Host "" -ForegroundColor White
        Write-Host "üë§ Test Accounts:" -ForegroundColor Cyan
        Write-Host "   üìß Email: student@edu.ru | teacher@edu.ru" -ForegroundColor White
        Write-Host "   üîë Password: 123" -ForegroundColor White
        Write-Host "" -ForegroundColor White
        Write-Host "üìä Current Status:" -ForegroundColor Cyan
        kubectl get pods -n eduplatform
        Write-Host "" -ForegroundColor White
        Write-Host "üöÄ Application is ready to use!" -ForegroundColor Green