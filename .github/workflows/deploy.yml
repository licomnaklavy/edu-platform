name: EDUPLATFORM CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        echo "Python dependencies installed"
    
    - name: Run basic import tests
      run: |
        cd backend
        echo "Running basic import tests..."
        python -c "
        try:
            import app.models
            import app.schemas
            import app.crud
            from app.models import User, Course
            from app.schemas import UserCreate, CourseCreate
            print('All basic imports work correctly')
        except Exception as e:
            print(f'Import test failed: {e}')
            exit(1)
        "
    
    - name: Build Backend Docker image
      run: |
        cd backend
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest .
        echo "Backend Docker image built"
    
    - name: Build Frontend Docker image
      run: |
        cd frontend
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest .
        echo "Frontend Docker image built"
    
    - name: Test Backend image functionality
      run: |
        echo "Testing Backend image..."
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }} python -c "import sys; print('Testing imports...'); import app.models; import app.schemas; import app.crud; from app.models import User, Course; from app.schemas import UserCreate, CourseCreate; print('All imports successful'); print('Backend image test PASSED')"
    
    - name: Test Frontend image build
      run: |
        echo "Testing Frontend image..."
        cd frontend
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }} .
        echo "Frontend image test completed"

  deploy-to-production:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Push Backend image to registry
      run: |
        cd backend
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
        echo "Backend image pushed to registry"
    
    - name: Push Frontend image to registry
      run: |
        cd frontend
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
        echo "Frontend image pushed to registry"
    
    - name: Set up Kubernetes
      uses: azure/setup-kubectl@v3
    
    - name: Configure Kubernetes access
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
        chmod 600 ~/.kube/config
        kubectl cluster-info
        kubectl get nodes
        echo "Kubernetes cluster access configured"
    
    - name: Deploy database layer
      run: |
        echo "Deploying database layer..."
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/postgresql.yaml
        kubectl apply -f k8s/redis.yaml
        kubectl wait --for=condition=ready pod -l app=postgresql -n eduplatform --timeout=300s
        echo "Database layer deployed"
    
    - name: Deploy application layer
      run: |
        echo "Deploying application layer..."
        sed -i 's|eduplatform-backend:local|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest|g' k8s/backend-api.yaml
        sed -i 's|eduplatform-frontend:local|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest|g' k8s/frontend.yaml
        kubectl apply -f k8s/backend-api.yaml
        kubectl apply -f k8s/frontend.yaml
        kubectl apply -f k8s/ingress.yaml
        echo "Application layer deployed"
    
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        kubectl rollout status deployment/backend-api -n eduplatform --timeout=600s
        kubectl rollout status deployment/frontend -n eduplatform --timeout=300s
        kubectl get pods -n eduplatform
        kubectl get svc -n eduplatform
        kubectl get ingress -n eduplatform
        echo "Deployment verification completed"
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        for i in 1 2 3 4 5 6; do
          if curl -f -s "http://localhost:30800/health" > /dev/null; then
            echo "Backend health check PASSED"
            break
          fi
          echo "Waiting for backend... attempt $i"
          sleep 10
        done
        
        if curl -f -s "http://localhost:30080" > /dev/null; then
          echo "Frontend accessibility test PASSED"
        else
          echo "Frontend not accessible yet"
        fi
        
        echo "Smoke tests completed"
    
    - name: Deployment summary
      run: |
        echo "DEPLOYMENT SUCCESSFUL"
        kubectl get all -n eduplatform
        echo "Frontend: http://localhost:30080"
        echo "Backend API: http://localhost:30800"