name: EDUPLATFORM CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        echo "Python dependencies installed"
    
    - name: Run basic import tests
      run: |
        cd backend
        echo "Running basic import tests..."
        python -c "
        try:
            import app.models
            import app.schemas
            import app.crud
            from app.models import User, Course
            from app.schemas import UserCreate, CourseCreate
            print('All basic imports work correctly')
        except Exception as e:
            print(f'Import test failed: {e}')
            exit(1)
        "
    
    - name: Build and Test Backend Docker image
      run: |
        cd backend
        docker build -t eduplatform-backend:ci .
        echo "Testing Backend image..."
        docker run --rm eduplatform-backend:ci python -c "import sys; print('Testing imports...'); import app.models; import app.schemas; import app.crud; from app.models import User, Course; from app.schemas import UserCreate, CourseCreate; print('All imports successful'); print('Backend image test PASSED')"
        echo "Backend Docker image built and tested"
    
    - name: Build and Test Frontend Docker image
      run: |
        cd frontend
        docker build -t eduplatform-frontend:ci .
        echo "Frontend Docker image built"

  deploy-to-production:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Backend image
      run: |
        cd backend
        docker build -t eduplatform-backend:latest .
        echo "Backend image built"
    
    - name: Build Frontend image
      run: |
        cd frontend
        docker build -t eduplatform-frontend:latest .
        echo "Frontend image built"
    
    - name: Set up Kubernetes
      uses: azure/setup-kubectl@v3
    
    - name: Configure Kubernetes access
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
        chmod 600 ~/.kube/config
        kubectl cluster-info
        kubectl get nodes
        echo "Kubernetes cluster access configured"
    
    - name: Import images to k3d
      run: |
        # Import images to k3d cluster
        k3d image import eduplatform-backend:latest -c eduplatform
        k3d image import eduplatform-frontend:latest -c eduplatform
        echo "Images imported to k3d cluster"
    
    - name: Deploy database layer
      run: |
        echo "Deploying database layer..."
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/postgresql.yaml
        kubectl apply -f k8s/redis.yaml
        
        # Wait for database to be ready
        echo "Waiting for PostgreSQL to be ready..."
        kubectl wait --for=condition=ready pod -l app=postgresql -n eduplatform --timeout=300s
        echo "Database layer deployed"
    
    - name: Deploy application layer
      run: |
        echo "Deploying application layer..."
        kubectl apply -f k8s/backend-api.yaml
        kubectl apply -f k8s/frontend.yaml
        kubectl apply -f k8s/ingress.yaml
        echo "Application layer deployed"
    
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        kubectl rollout status deployment/backend-api -n eduplatform --timeout=600s
        kubectl rollout status deployment/frontend -n eduplatform --timeout=300s
        kubectl get pods -n eduplatform
        kubectl get svc -n eduplatform
        kubectl get ingress -n eduplatform
        echo "Deployment verification completed"
    
    - name: Run smoke tests
      run: |
        echo "Running smoke tests..."
        for i in 1 2 3 4 5 6; do
          if curl -f -s "http://localhost:30800/health" > /dev/null; then
            echo "Backend health check PASSED"
            break
          fi
          echo "Waiting for backend... attempt $i"
          sleep 10
        done
        
        if curl -f -s "http://localhost:30080" > /dev/null; then
          echo "Frontend accessibility test PASSED"
        else
          echo "Frontend not accessible yet"
        fi
        
        echo "Smoke tests completed"
    
    - name: Deployment summary
      run: |
        echo "DEPLOYMENT SUCCESSFUL"
        kubectl get all -n eduplatform
        echo "Frontend: http://localhost:30080"
        echo "Backend API: http://localhost:30800"