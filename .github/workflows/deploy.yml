name: EDUPLATFORM CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        echo "Python dependencies installed"
    
    - name: Run basic import tests
      run: |
        cd backend
        echo "Running basic import tests..."
        python -c "
        try:
            import app.models
            import app.schemas
            import app.crud
            from app.models import User, Course
            from app.schemas import UserCreate, CourseCreate
            print('All basic imports work correctly')
        except Exception as e:
            print(f'Import test failed: {e}')
            exit(1)
        "
    
    - name: Build and Test Backend Docker image
      run: |
        cd backend
        docker build -t eduplatform-backend:ci .
        echo "Testing Backend image..."
        docker run --rm eduplatform-backend:ci python -c "import sys; print('Testing imports...'); import app.models; import app.schemas; import app.crud; from app.models import User, Course; from app.schemas import UserCreate, CourseCreate; print('All imports successful'); print('Backend image test PASSED')"
        echo "Backend Docker image built and tested"
    
    - name: Build and Test Frontend Docker image
      run: |
        cd frontend
        docker build -t eduplatform-frontend:ci .
        echo "Frontend Docker image built"

  deploy:
    needs: build-and-test
    runs-on: self-hosted
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Cleanup previous deployment
      run: |
        echo "Cleaning up previous deployment..."
        kubectl delete -f k8s/ --ignore-not-found=true || true
        kubectl delete namespace eduplatform --ignore-not-found=true || true
        k3d cluster delete eduplatform --all || true
        docker system prune -f
        echo "Cleanup completed"
    
    - name: Create k3d cluster
      run: |
        echo "Creating k3d cluster..."
        k3d cluster create eduplatform \
          --port "80:30080@loadbalancer" \
          --port "8000:30800@loadbalancer" \
          --agents 2
        echo "k3d cluster created"
    
    - name: Build Docker images
      run: |
        echo "Building Docker images..."
        
        echo "Building backend..."
        cd backend
        docker build -t eduplatform-backend:latest .
        
        echo "Building frontend..."
        cd ../frontend
        docker build -t eduplatform-frontend:latest .
        
        echo "Docker images built"
    
    - name: Import images to k3d
      run: |
        echo "Importing images to k3d cluster..."
        k3d image import eduplatform-backend:latest -c eduplatform
        k3d image import eduplatform-frontend:latest -c eduplatform
        echo "Images imported"
    
    - name: Deploy infrastructure
      run: |
        echo "Deploying infrastructure..."
        
        echo "Creating namespace..."
        kubectl apply -f k8s/namespace.yaml
        
        echo "Deploying config..."
        kubectl apply -f k8s/configmap.yaml
        
        echo "Deploying database..."
        kubectl apply -f k8s/postgresql.yaml
        kubectl apply -f k8s/redis.yaml
        
        echo "Infrastructure deployed"
    
    - name: Wait for database
      run: |
        echo "Waiting for database to be ready..."
        kubectl wait --for=condition=ready pod -l app=postgresql -n eduplatform --timeout=180s
        echo "Database is ready"
    
    - name: Deploy applications
      run: |
        echo "Deploying applications..."
        
        echo "Deploying backend API..."
        kubectl apply -f k8s/backend-api.yaml

        echo "Deploying backend auth..."
        kubectl apply -f k8s/backend-auth.yaml
        
        echo "Deploying frontend..."
        kubectl apply -f k8s/frontend.yaml

        echo "Deploying other services..."
        kubectl apply -f k8s/backup-service.yaml
        kubectl apply -f k8s/health-monitor.yaml
        
        echo "Deploying ingress..."
        kubectl apply -f k8s/ingress.yaml
        
        echo "Applications deployed"
    
    - name: Wait for applications
      run: |
        echo "Waiting for applications to be ready..."
        
        echo "Waiting for backend..."
        kubectl wait --for=condition=ready pod -l app=backend-api -n eduplatform --timeout=300s
        
        echo "Waiting for frontend..."
        kubectl wait --for=condition=ready pod -l app=frontend -n eduplatform --timeout=180s
        
        echo "All applications are ready"
    
    - name: Run health checks
      run: |
        echo "Running health checks..."
        
        echo "Checking backend health..."
        max_retries=10
        retry_count=0
        
        while [ $retry_count -lt $max_retries ]; do
          if curl -f -s http://localhost:8000/health > /dev/null; then
            echo "Backend health check passed"
            break
          else
            echo "Backend not ready yet... ($((retry_count + 1))/$max_retries)"
            sleep 5
          fi
          retry_count=$((retry_count + 1))
        done
        
        if [ $retry_count -eq $max_retries ]; then
          echo "Backend health check failed"
          exit 1
        fi
        
        echo "All health checks passed"
    
    - name: Display deployment info
      run: |
        echo ""
        echo "DEPLOYMENT SUCCESSFUL!"
        echo "=========================================="
        echo "Frontend:     http://localhost:80"
        echo "Backend API:  http://localhost:8000"
        echo "API Docs:     http://localhost:8000/docs"
        echo "Health Check: http://localhost:8000/health"
        echo ""
        echo "Test Accounts:"
        echo "Email: student@edu.ru | teacher@edu.ru"
        echo "Password: 123"
        echo ""
        echo "Current Status:"
        kubectl get pods -n eduplatform
        echo ""
        echo "Application is ready to use!"