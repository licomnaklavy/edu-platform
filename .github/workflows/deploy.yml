name: EDUPLATFORM Local Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Ğ­Ñ‚Ğ°Ğ¿ 1: Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ±ĞµĞ· Ğ‘Ğ”)
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        echo "âœ… Python dependencies installed"
    
    - name: Run Python import tests (Ğ±ĞµĞ· Ğ‘Ğ”)
      run: |
        cd backend
        echo "ğŸ” Running Python import tests..."
        python -c "import os; os.environ['TEST_MODE'] = 'true'; os.environ['SKIP_DB_INIT'] = 'true'; import app.models; import app.schemas; import app.crud; from app.models import User, Course; from app.schemas import UserCreate, CourseCreate; print('âœ… All Python imports work correctly'); user = User(email='test@test.com', password='test', name='Test User'); course = Course(name='Test Course', description='Test', hours=10, level='beginner'); print('âœ… Model object creation successful'); user_data = UserCreate(email='test@example.com', password='test123', name='Test User'); course_data = CourseCreate(name='Test Course', description='Test', hours=10, level='beginner'); print('âœ… Schema validation successful')"
    
    - name: Run schema validation tests
      run: |
        cd backend
        echo "ğŸ” Running schema validation tests..."
        python -c "import os; os.environ['TEST_MODE'] = 'true'; from app.schemas import UserCreate, CourseCreate, UserLogin; user_data = UserCreate(email='test@example.com', password='testpassword123', name='Test User'); assert user_data.email == 'test@example.com'; assert user_data.name == 'Test User'; course_data = CourseCreate(name='Test Course', description='Test Description', hours=10, level='beginner'); assert course_data.name == 'Test Course'; assert course_data.hours == 10; login_data = UserLogin(email='test@example.com', password='testpassword123'); assert login_data.email == 'test@example.com'; print('âœ… All schema validations passed')"
    
    - name: Test CRUD functions (Ğ±ĞµĞ· Ğ‘Ğ”)
      run: |
        cd backend
        echo "ğŸ” Testing CRUD functions..."
        python -c "import os; os.environ['TEST_MODE'] = 'true'; from app import crud; hashed_password = crud.get_password_hash('testpassword'); print('âœ… Password hashing works'); verify_result = crud.verify_password('testpassword', hashed_password); assert verify_result == True; print('âœ… Password verification works'); print('âœ… CRUD utility functions test passed')"
    
    - name: Build Backend Docker image
      run: |
        cd backend
        echo "ğŸ³ Building Backend Docker image..."
        docker build -t eduplatform-backend:latest .
        echo "âœ… Backend Docker image built"

    - name: Build Frontend Docker image
      run: |
        cd frontend
        echo "ğŸ³ Building Frontend Docker image..."
        docker build -t eduplatform-frontend:latest .
        echo "âœ… Frontend Docker image built"

    - name: Validate Kubernetes manifests
      run: |
        echo "ğŸ” Validating Kubernetes manifests..."
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ²ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‚
        if [ ! -f "k8s/namespace.yaml" ]; then echo "âŒ Missing k8s/namespace.yaml"; exit 1; fi
        if [ ! -f "k8s/configmap.yaml" ]; then echo "âŒ Missing k8s/configmap.yaml"; exit 1; fi
        if [ ! -f "k8s/postgresql.yaml" ]; then echo "âŒ Missing k8s/postgresql.yaml"; exit 1; fi
        if [ ! -f "k8s/redis.yaml" ]; then echo "âŒ Missing k8s/redis.yaml"; exit 1; fi
        if [ ! -f "k8s/backend-api.yaml" ]; then echo "âŒ Missing k8s/backend-api.yaml"; exit 1; fi
        if [ ! -f "k8s/frontend.yaml" ]; then echo "âŒ Missing k8s/frontend.yaml"; exit 1; fi
        if [ ! -f "k8s/ingress.yaml" ]; then echo "âŒ Missing k8s/ingress.yaml"; exit 1; fi
        echo "âœ… All Kubernetes manifests are valid"

  # Ğ­Ñ‚Ğ°Ğ¿ 2: Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½ÑƒÑ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñƒ
  deploy-local:
    needs: test  # Ğ–Ğ´ĞµĞ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
    runs-on: self-hosted  # ğŸ¯ ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ - Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ½Ğ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğµ!
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Stop existing deployment
      run: |
        echo "ğŸ›‘ Stopping existing deployment..."
        kubectl delete -f k8s/ --ignore-not-found=true || true
        k3d cluster delete eduplatform-local || true
        echo "âœ… Existing deployment stopped"
    
    - name: Set up k3d cluster
      run: |
        echo "ğŸš€ Setting up local k3d cluster..."
        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ k3d ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
        if ! command -v k3d &> /dev/null; then
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
        fi
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€
        k3d cluster create eduplatform-local \
          --port "8080:30080@loadbalancer" \
          --port "8000:30800@loadbalancer" \
          --agents 1
        echo "âœ… k3d local cluster created"
    
    - name: Build and import images to k3d
      run: |
        echo "ğŸ³ Building and importing Docker images..."
        
        # Build Backend
        cd backend
        docker build -t eduplatform-backend:local .
        echo "âœ… Backend image built"
        
        # Build Frontend  
        cd ../frontend
        docker build -t eduplatform-frontend:local .
        echo "âœ… Frontend image built"
        
        # Import to k3d
        k3d image import eduplatform-backend:local -c eduplatform-local
        k3d image import eduplatform-frontend:local -c eduplatform-local
        echo "âœ… Images imported to k3d cluster"
    
    - name: Deploy to Kubernetes
      run: |
        echo "ğŸ—ï¸ Deploying application to local Kubernetes..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ namespace
        kubectl apply -f k8s/namespace.yaml
        echo "âœ… Namespace created"
        
        # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/postgresql.yaml
        kubectl apply -f k8s/redis.yaml
        echo "âœ… Infrastructure deployed"
        
        # Ğ–Ğ´ĞµĞ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ‘Ğ”
        echo "â³ Waiting for PostgreSQL to be ready..."
        kubectl wait --for=condition=ready pod -l app=postgresql -n eduplatform --timeout=180s
        echo "âœ… PostgreSQL is ready"
        
        # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ğ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
        kubectl apply -f k8s/backend-api.yaml
        kubectl apply -f k8s/frontend.yaml
        kubectl apply -f k8s/ingress.yaml
        echo "âœ… Applications deployed"
    
    - name: Wait for application readiness
      run: |
        echo "â³ Waiting for applications to be ready..."
        
        # Ğ–Ğ´ĞµĞ¼ Ğ±ÑĞºĞµĞ½Ğ´
        kubectl wait --for=condition=ready pod -l app=backend-api -n eduplatform --timeout=300s
        echo "âœ… Backend API is ready"
        
        # Ğ–Ğ´ĞµĞ¼ Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´
        kubectl wait --for=condition=ready pod -l app=frontend -n eduplatform --timeout=180s
        echo "âœ… Frontend is ready"
    
    - name: Run local smoke tests
      run: |
        echo "ğŸ§ª Running local smoke tests..."
        
        # Test backend health endpoint
        echo "ğŸ” Testing backend health..."
        for i in {1..20}; do
          if curl -f -s "http://localhost:8000/health" > /dev/null; then
            echo "âœ… Backend health check PASSED"
            break
          fi
          echo "â³ Waiting for backend... attempt $i/20"
          sleep 3
        done
        
        # Test frontend accessibility
        echo "ğŸ” Testing frontend accessibility..."
        for i in {1..15}; do
          if curl -f -s "http://localhost:8080" > /dev/null; then
            echo "âœ… Frontend accessibility test PASSED"
            break
          fi
          echo "â³ Waiting for frontend... attempt $i/15"
          sleep 2
        done
        
        # Test API endpoints
        echo "ğŸ” Testing API endpoints..."
        if curl -f -s "http://localhost:8000/" > /dev/null; then
          echo "âœ… API root endpoint PASSED"
        else
          echo "âŒ API root endpoint FAILED"
          exit 1
        fi
        
        echo "âœ… All smoke tests completed successfully"
    
    - name: Display deployment information
      run: |
        echo "ğŸ‰ LOCAL DEPLOYMENT SUCCESSFUL!"
        echo ""
        echo "=== ACCESS URLs ==="
        echo "ğŸŒ Frontend:     http://localhost:8080"
        echo "ğŸ”§ Backend API:  http://localhost:8000" 
        echo "ğŸ“š API Docs:     http://localhost:8000/docs"
        echo "â¤ï¸  Health Check: http://localhost:8000/health"
        echo ""
        echo "=== TEST ACCOUNTS ==="
        echo "ğŸ“§ Email: student@edu.ru | teacher@edu.ru"
        echo "ğŸ”‘ Password: 123"
        echo ""
        echo "=== KUBERNETES STATUS ==="
        kubectl get pods -n eduplatform
        echo ""
        echo "=== DOCKER IMAGES ==="
        docker images | grep eduplatform