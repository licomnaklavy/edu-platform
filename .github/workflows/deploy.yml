name: EDUPLATFORM CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # –≠—Ç–∞–ø 1: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        echo "‚úÖ Python dependencies installed"
    
    - name: Run Python import tests
      run: |
        cd backend
        echo "üîç Running Python import tests..."
        python -c "
        try:
            import app.models
            import app.schemas
            import app.crud
            import app.database
            import app.main
            from app.models import User, Course
            from app.schemas import UserCreate, CourseCreate
            print('‚úÖ All Python imports work correctly')
        except Exception as e:
            print(f'‚ùå Import test failed: {e}')
            exit(1)
        "
    
    - name: Run schema validation tests
      run: |
        cd backend
        echo "üîç Running schema validation tests..."
        python -c "
        try:
            from app.schemas import UserCreate, CourseCreate, UserLogin
            # Test UserCreate schema
            user_data = UserCreate(
                email='test@example.com',
                password='testpassword123',
                name='Test User'
            )
            # Test CourseCreate schema  
            course_data = CourseCreate(
                name='Test Course',
                description='Test Description',
                hours=10,
                level='beginner'
            )
            # Test UserLogin schema
            login_data = UserLogin(
                email='test@example.com', 
                password='testpassword123'
            )
            print('‚úÖ All schema validations passed')
        except Exception as e:
            print(f'‚ùå Schema test failed: {e}')
            exit(1)
        "
    
    - name: Build and test Backend Docker image
      run: |
        cd backend
        echo "üê≥ Building Backend Docker image..."
        docker build -t eduplatform-backend:ci .
        
        echo "üß™ Testing Backend image..."
        docker run --rm eduplatform-backend:ci python -c "
        import sys
        print('üîç Testing imports in container...')
        try:
            import app.models
            import app.schemas  
            import app.crud
            import app.database
            import app.main
            from app.models import User, Course
            from app.schemas import UserCreate, CourseCreate
            print('‚úÖ All container imports successful')
            print('‚úÖ Backend Docker image test PASSED')
        except Exception as e:
            print(f'‚ùå Container import test failed: {e}')
            sys.exit(1)
        "
        echo "‚úÖ Backend Docker image built and tested"
    
    - name: Build and test Frontend Docker image
      run: |
        cd frontend
        echo "üê≥ Building Frontend Docker image..."
        docker build -t eduplatform-frontend:ci .
        
        echo "üß™ Testing Frontend image..."
        docker run --rm -d -p 8080:80 --name frontend-test eduplatform-frontend:ci
        sleep 5
        
        # Test if nginx is serving files
        if curl -f -s http://localhost:8080/index.html > /dev/null; then
            echo "‚úÖ Frontend container is serving files correctly"
            docker stop frontend-test
        else
            echo "‚ùå Frontend container test failed"
            docker stop frontend-test
            exit 1
        fi
        echo "‚úÖ Frontend Docker image built and tested"

    - name: Run Kubernetes manifest validation
      run: |
        echo "üîç Validating Kubernetes manifests..."
        # Check if all required k8s files exist
        required_files=(
          "k8s/namespace.yaml"
          "k8s/configmap.yaml" 
          "k8s/postgresql.yaml"
          "k8s/redis.yaml"
          "k8s/backend-api.yaml"
          "k8s/frontend.yaml"
          "k8s/ingress.yaml"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå Missing required file: $file"
            exit 1
          fi
          echo "‚úÖ Found: $file"
        done
        
        # Basic YAML syntax check
        for file in k8s/*.yaml; do
          if python -c "import yaml; yaml.safe_load(open('$file'))"; then
            echo "‚úÖ Valid YAML: $file"
          else
            echo "‚ùå Invalid YAML: $file"
            exit 1
          fi
        done
        
        echo "‚úÖ All Kubernetes manifests are valid"

  # –≠—Ç–∞–ø 2: –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏)
  deploy-to-production:
    needs: build-and-test  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # –¢–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up k3d cluster
      run: |
        echo "üöÄ Setting up production k3d cluster..."
        # Install k3d
        curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
        
        # Create production k3d cluster
        k3d cluster create eduplatform-prod \
          --port "80:30080@loadbalancer" \
          --port "8000:30800@loadbalancer" \
          --agents 1
        echo "‚úÖ k3d production cluster created"
    
    - name: Build production Docker images
      run: |
        echo "üê≥ Building production Docker images..."
        
        # Build Backend
        cd backend
        docker build -t eduplatform-backend:prod .
        echo "‚úÖ Backend production image built"
        
        # Build Frontend  
        cd ../frontend
        docker build -t eduplatform-frontend:prod .
        echo "‚úÖ Frontend production image built"
    
    - name: Import images to k3d cluster
      run: |
        echo "üì¶ Importing images to k3d cluster..."
        k3d image import eduplatform-backend:prod -c eduplatform-prod
        k3d image import eduplatform-frontend:prod -c eduplatform-prod
        echo "‚úÖ Production images imported to k3d cluster"
    
    - name: Set up Kubernetes tools
      uses: azure/setup-kubectl@v3
    
    - name: Deploy infrastructure layer
      run: |
        echo "üèóÔ∏è Deploying infrastructure layer..."
        
        # Create namespace first
        kubectl apply -f k8s/namespace.yaml
        echo "‚úÖ Namespace created"
        
        # Deploy configuration
        kubectl apply -f k8s/configmap.yaml
        echo "‚úÖ ConfigMap deployed"
        
        # Deploy database
        kubectl apply -f k8s/postgresql.yaml
        kubectl apply -f k8s/redis.yaml
        echo "‚úÖ Database services deployed"
        
        # Wait for database to be ready
        echo "‚è≥ Waiting for PostgreSQL to be ready..."
        kubectl wait --for=condition=ready pod -l app=postgresql -n eduplatform --timeout=300s
        echo "‚úÖ PostgreSQL is ready"
    
    - name: Deploy application layer
      run: |
        echo "üöÄ Deploying application layer..."
        
        # Deploy backend
        kubectl apply -f k8s/backend-api.yaml
        echo "‚úÖ Backend API deployed"
        
        # Deploy frontend
        kubectl apply -f k8s/frontend.yaml
        echo "‚úÖ Frontend deployed"
        
        # Deploy ingress
        kubectl apply -f k8s/ingress.yaml
        echo "‚úÖ Ingress deployed"
    
    - name: Wait for application readiness
      run: |
        echo "‚è≥ Waiting for applications to be ready..."
        
        # Wait for backend
        kubectl wait --for=condition=ready pod -l app=backend-api -n eduplatform --timeout=600s
        echo "‚úÖ Backend API is ready"
        
        # Wait for frontend
        kubectl wait --for=condition=ready pod -l app=frontend -n eduplatform --timeout=300s
        echo "‚úÖ Frontend is ready"
    
    - name: Run production smoke tests
      run: |
        echo "üß™ Running production smoke tests..."
        
        # Test backend health endpoint
        echo "üîç Testing backend health..."
        for i in {1..30}; do
          if curl -f -s "http://localhost:30800/health" > /dev/null; then
            echo "‚úÖ Backend health check PASSED"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "‚ùå Backend health check FAILED after 30 attempts"
            exit 1
          fi
          echo "‚è≥ Waiting for backend... attempt $i/30"
          sleep 5
        done
        
        # Test frontend accessibility
        echo "üîç Testing frontend accessibility..."
        for i in {1..20}; do
          if curl -f -s "http://localhost:30080" > /dev/null; then
            echo "‚úÖ Frontend accessibility test PASSED"
            break
          fi
          if [ $i -eq 20 ]; then
            echo "‚ùå Frontend accessibility test FAILED after 20 attempts"
            exit 1
          fi
          echo "‚è≥ Waiting for frontend... attempt $i/20"
          sleep 3
        done
        
        # Test API endpoints
        echo "üîç Testing API endpoints..."
        if curl -f -s "http://localhost:30800/" > /dev/null; then
          echo "‚úÖ API root endpoint PASSED"
        else
          echo "‚ùå API root endpoint FAILED"
          exit 1
        fi
        
        echo "‚úÖ All smoke tests completed successfully"
    
    - name: Verify deployment status
      run: |
        echo "üìä Verifying deployment status..."
        
        echo "=== PODS STATUS ==="
        kubectl get pods -n eduplatform -o wide
        
        echo ""
        echo "=== SERVICES STATUS ==="
        kubectl get svc -n eduplatform
        
        echo ""
        echo "=== INGRESS STATUS ==="
        kubectl get ingress -n eduplatform
        
        echo ""
        echo "=== DEPLOYMENT STATUS ==="
        kubectl get deployments -n eduplatform
    
    - name: Deployment success summary
      run: |
        echo "üéâ DEPLOYMENT SUCCESSFUL!"
        echo ""
        echo "=== PRODUCTION ENVIRONMENT ==="
        echo "üì± Access URLs:"
        echo "   Frontend:     http://localhost:30080"
        echo "   Backend API:  http://localhost:30800"
        echo "   API Docs:     http://localhost:30800/docs"
        echo "   Health Check: http://localhost:30800/health"
        echo ""
        echo "=== CLUSTER INFO ==="
        kubectl cluster-info
        echo ""
        echo "=== RESOURCE USAGE ==="
        kubectl top nodes 2>/dev/null || echo "Metrics not available"
        kubectl top pods -n eduplatform 2>/dev/null || echo "Pod metrics not available"

  # –≠—Ç–∞–ø 3: –û—á–∏—Å—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  cleanup:
    needs: deploy-to-production
    runs-on: ubuntu-latest
    if: always()  # –í—Å–µ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ —É–ø–∞–ª–∏
    
    steps:
    - name: Cleanup k3d cluster
      run: |
        echo "üßπ Cleaning up k3d cluster..."
        k3d cluster delete eduplatform-prod || true
        echo "‚úÖ k3d cluster cleaned up"
    
    - name: Cleanup Docker images
      run: |
        echo "üßπ Cleaning up Docker images..."
        docker system prune -f || true
        echo "‚úÖ Docker cleanup completed"