name: Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository | lower }}  # ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω | lower

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
    
    - name: Run Python tests
      run: |
        cd backend
        python -m pytest tests/ -v || echo "No tests found - continuing"
    
    - name: Build Backend
      run: |
        cd backend
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest .
    
    - name: Build Frontend
      run: |
        cd frontend
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest .
    
    - name: Test Backend Image
      run: |
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }} python -c "import app.main; print('‚úÖ Backend imports work')"
    
    - name: Test Frontend Image
      run: |
        docker run --rm ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest nginx -t

  deploy-to-k8s:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and Push Backend
      run: |
        cd backend
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest .
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest
    
    - name: Build and Push Frontend
      run: |
        cd frontend
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest .
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest
    
    - name: Setup Kubernetes
      uses: azure/setup-kubectl@v3
    
    - name: Configure Kubeconfig
      run: |
        echo "${{ secrets.KUBECONFIG }}" > kubeconfig.yaml
        export KUBECONFIG=kubeconfig.yaml
    
    - name: Deploy to Kubernetes
      run: |
        export KUBECONFIG=kubeconfig.yaml
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        kubectl cluster-info
        kubectl get nodes
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö
        sed -i 's|eduplatform-backend:local|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend:latest|g' k8s/backend-api.yaml
        sed -i 's|eduplatform-frontend:local|${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend:latest|g' k8s/frontend.yaml
        
        # –î–µ–ø–ª–æ–π (–ë–ï–ó network-policy.yaml)
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/postgresql.yaml
        kubectl apply -f k8s/redis.yaml
        
        # –ñ–¥–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
        kubectl wait --for=condition=ready pod -l app=postgresql -n eduplatform --timeout=180s
        
        kubectl apply -f k8s/backend-api.yaml
        kubectl apply -f k8s/frontend.yaml
        kubectl apply -f k8s/ingress.yaml
    
    - name: Verify Deployment
      run: |
        export KUBECONFIG=kubeconfig.yaml
        kubectl rollout status deployment/backend-api -n eduplatform --timeout=300s
        kubectl rollout status deployment/frontend -n eduplatform --timeout=300s
        kubectl get pods,svc,ingress -n eduplatform
        echo "üöÄ Deployment completed successfully!"