name: EDUPLATFORM CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Ð­Ñ‚Ð°Ð¿ 1: Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (Ð±ÐµÐ· Ð‘Ð”)
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        echo "âœ… Python dependencies installed"
    
    - name: Run Python import tests (Ð±ÐµÐ· Ð‘Ð”)
      run: |
        cd backend
        echo "ðŸ” Running Python import tests..."
        python -c "
        try:
            # Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð±ÐµÐ· Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð‘Ð”
            import app.models
            import app.schemas
            import app.crud
            import app.main
            from app.models import User, Course
            from app.schemas import UserCreate, CourseCreate
            
            print('âœ… All Python imports work correctly')
            
            # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² Ð±ÐµÐ· ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð² Ð‘Ð”
            user = User(email='test@test.com', password='test', name='Test User')
            course = Course(name='Test Course', description='Test', hours=10, level='beginner')
            
            print('âœ… Model object creation successful')
            
        except Exception as e:
            print(f'âŒ Import test failed: {e}')
            exit(1)
        "
    
    - name: Run schema validation tests
      run: |
        cd backend
        echo "ðŸ” Running schema validation tests..."
        python -c "
        try:
            from app.schemas import UserCreate, CourseCreate, UserLogin
            
            # Test UserCreate schema
            user_data = UserCreate(
                email='test@example.com',
                password='testpassword123', 
                name='Test User'
            )
            assert user_data.email == 'test@example.com'
            assert user_data.name == 'Test User'
            
            # Test CourseCreate schema
            course_data = CourseCreate(
                name='Test Course',
                description='Test Description', 
                hours=10,
                level='beginner'
            )
            assert course_data.name == 'Test Course'
            assert course_data.hours == 10
            
            # Test UserLogin schema
            login_data = UserLogin(
                email='test@example.com',
                password='testpassword123'
            )
            assert login_data.email == 'test@example.com'
            
            print('âœ… All schema validations passed')
            
        except Exception as e:
            print(f'âŒ Schema test failed: {e}')
            exit(1)
        "
    
    - name: Test CRUD functions (Ð±ÐµÐ· Ð‘Ð”)
      run: |
        cd backend
        echo "ðŸ” Testing CRUD functions..."
        python -c "
        try:
            from app import crud
            from app.schemas import UserCreate, CourseCreate
            
            # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ…ÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¹
            hashed_password = crud.get_password_hash('testpassword')
            print('âœ… Password hashing works')
            
            # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÐµÑ€Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÑŽ Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¹
            verify_result = crud.verify_password('testpassword', hashed_password)
            assert verify_result == True
            print('âœ… Password verification works')
            
            print('âœ… CRUD utility functions test passed')
            
        except Exception as e:
            print(f'âŒ CRUD test failed: {e}')
            exit(1)
        "
    
    - name: Build and test Backend Docker image (Ñ Ð¼Ð¾ÐºÐ¾Ð¼ Ð‘Ð”)
      run: |
        cd backend
        echo "ðŸ³ Building Backend Docker image..."
        docker build -t eduplatform-backend:ci .
        
        echo "ðŸ§ª Testing Backend image (Ð±ÐµÐ· Ð‘Ð”)..."
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
        docker run --rm \
          -e DATABASE_URL=sqlite:///:memory: \
          -e TEST_MODE=true \
          eduplatform-backend:ci python -c "
        import sys
        import os
        print('ðŸ” Testing imports in container...')
        try:
            # Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»Ð¸
            import app.models
            import app.schemas
            import app.crud
            from app.models import User, Course
            from app.schemas import UserCreate, CourseCreate
            
            print('âœ… All container imports successful')
            
            # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð±ÐµÐ· Ð‘Ð”
            user_schema = UserCreate(
                email='container@test.com', 
                password='test123',
                name='Container User'
            )
            print('âœ… Schema creation in container works')
            
            print('âœ… Backend Docker image test PASSED')
            
        except Exception as e:
            print(f'âŒ Container import test failed: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
        echo "âœ… Backend Docker image built and tested"
    
    - name: Build and test Frontend Docker image
      run: |
        cd frontend
        echo "ðŸ³ Building Frontend Docker image..."
        docker build -t eduplatform-frontend:ci .
        
        echo "ðŸ§ª Testing Frontend image..."
        docker run --rm -d -p 8080:80 --name frontend-test eduplatform-frontend:ci
        sleep 5
        
        # Test if nginx is serving files
        if curl -f -s http://localhost:8080/index.html > /dev/null; then
            echo "âœ… Frontend container is serving files correctly"
            docker stop frontend-test
        else
            echo "âŒ Frontend container test failed"
            docker logs frontend-test
            docker stop frontend-test
            exit 1
        fi
        echo "âœ… Frontend Docker image built and tested"

    - name: Run Kubernetes manifest validation
      run: |
        echo "ðŸ” Validating Kubernetes manifests..."
        # Check if all required k8s files exist
        required_files=(
          "k8s/namespace.yaml"
          "k8s/configmap.yaml" 
          "k8s/postgresql.yaml"
          "k8s/redis.yaml"
          "k8s/backend-api.yaml"
          "k8s/frontend.yaml"
          "k8s/ingress.yaml"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          fi
          echo "âœ… Found: $file"
        done
        
        # Basic YAML syntax check
        for file in k8s/*.yaml; do
          if python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
            echo "âœ… Valid YAML: $file"
          else
            echo "âŒ Invalid YAML: $file"
            exit 1
          fi
        done
        
        echo "âœ… All Kubernetes manifests are valid"

    - name: Test Docker Compose configuration
      run: |
        echo "ðŸ” Testing Docker Compose configuration..."
        if [ -f "docker-compose.yml" ]; then
          docker-compose config > /dev/null
          echo "âœ… Docker Compose configuration is valid"
        else
          echo "âš ï¸  docker-compose.yml not found, skipping"
        fi

  # Ð­Ñ‚Ð°Ð¿ 2: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ main Ð²ÐµÑ‚ÐºÐ¸)
  deploy-to-production:
    needs: build-and-test  # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ main Ð²ÐµÑ‚ÐºÐ¸
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up k3d cluster
      run: |
        echo "ðŸš€ Setting up production k3d cluster..."
        # Install k3d
        curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
        
        # Create production k3d cluster
        k3d cluster create eduplatform-prod \
          --port "80:30080@loadbalancer" \
          --port "8000:30800@loadbalancer" \
          --agents 1
        echo "âœ… k3d production cluster created"
    
    - name: Build production Docker images
      run: |
        echo "ðŸ³ Building production Docker images..."
        
        # Build Backend
        cd backend
        docker build -t eduplatform-backend:prod .
        echo "âœ… Backend production image built"
        
        # Build Frontend  
        cd ../frontend
        docker build -t eduplatform-frontend:prod .
        echo "âœ… Frontend production image built"
    
    - name: Import images to k3d cluster
      run: |
        echo "ðŸ“¦ Importing images to k3d cluster..."
        k3d image import eduplatform-backend:prod -c eduplatform-prod
        k3d image import eduplatform-frontend:prod -c eduplatform-prod
        echo "âœ… Production images imported to k3d cluster"
    
    - name: Set up Kubernetes tools
      uses: azure/setup-kubectl@v3
    
    - name: Deploy infrastructure layer
      run: |
        echo "ðŸ—ï¸ Deploying infrastructure layer..."
        
        # Create namespace first
        kubectl apply -f k8s/namespace.yaml
        echo "âœ… Namespace created"
        
        # Deploy configuration
        kubectl apply -f k8s/configmap.yaml
        echo "âœ… ConfigMap deployed"
        
        # Deploy database
        kubectl apply -f k8s/postgresql.yaml
        kubectl apply -f k8s/redis.yaml
        echo "âœ… Database services deployed"
        
        # Wait for database to be ready
        echo "â³ Waiting for PostgreSQL to be ready..."
        kubectl wait --for=condition=ready pod -l app=postgresql -n eduplatform --timeout=300s
        echo "âœ… PostgreSQL is ready"
    
    - name: Deploy application layer
      run: |
        echo "ðŸš€ Deploying application layer..."
        
        # Deploy backend
        kubectl apply -f k8s/backend-api.yaml
        echo "âœ… Backend API deployed"
        
        # Deploy frontend
        kubectl apply -f k8s/frontend.yaml
        echo "âœ… Frontend deployed"
        
        # Deploy ingress
        kubectl apply -f k8s/ingress.yaml
        echo "âœ… Ingress deployed"
    
    - name: Wait for application readiness
      run: |
        echo "â³ Waiting for applications to be ready..."
        
        # Wait for backend
        kubectl wait --for=condition=ready pod -l app=backend-api -n eduplatform --timeout=600s
        echo "âœ… Backend API is ready"
        
        # Wait for frontend
        kubectl wait --for=condition=ready pod -l app=frontend -n eduplatform --timeout=300s
        echo "âœ… Frontend is ready"
    
    - name: Run production smoke tests
      run: |
        echo "ðŸ§ª Running production smoke tests..."
        
        # Test backend health endpoint
        echo "ðŸ” Testing backend health..."
        for i in {1..30}; do
          if curl -f -s "http://localhost:30800/health" > /dev/null; then
            echo "âœ… Backend health check PASSED"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Backend health check FAILED after 30 attempts"
            exit 1
          fi
          echo "â³ Waiting for backend... attempt $i/30"
          sleep 5
        done
        
        # Test frontend accessibility
        echo "ðŸ” Testing frontend accessibility..."
        for i in {1..20}; do
          if curl -f -s "http://localhost:30080" > /dev/null; then
            echo "âœ… Frontend accessibility test PASSED"
            break
          fi
          if [ $i -eq 20 ]; then
            echo "âŒ Frontend accessibility test FAILED after 20 attempts"
            exit 1
          fi
          echo "â³ Waiting for frontend... attempt $i/20"
          sleep 3
        done
        
        # Test API endpoints
        echo "ðŸ” Testing API endpoints..."
        if curl -f -s "http://localhost:30800/" > /dev/null; then
          echo "âœ… API root endpoint PASSED"
        else
          echo "âŒ API root endpoint FAILED"
          exit 1
        fi
        
        echo "âœ… All smoke tests completed successfully"
    
    - name: Verify deployment status
      run: |
        echo "ðŸ“Š Verifying deployment status..."
        
        echo "=== PODS STATUS ==="
        kubectl get pods -n eduplatform -o wide
        
        echo ""
        echo "=== SERVICES STATUS ==="
        kubectl get svc -n eduplatform
        
        echo ""
        echo "=== INGRESS STATUS ==="
        kubectl get ingress -n eduplatform
        
        echo ""
        echo "=== DEPLOYMENT STATUS ==="
        kubectl get deployments -n eduplatform
    
    - name: Deployment success summary
      run: |
        echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
        echo ""
        echo "=== PRODUCTION ENVIRONMENT ==="
        echo "ðŸ“± Access URLs:"
        echo "   Frontend:     http://localhost:30080"
        echo "   Backend API:  http://localhost:30800"
        echo "   API Docs:     http://localhost:30800/docs"
        echo "   Health Check: http://localhost:30800/health"
        echo ""
        echo "=== CLUSTER INFO ==="
        kubectl cluster-info
        echo ""
        echo "=== RESOURCE USAGE ==="
        kubectl top nodes 2>/dev/null || echo "Metrics not available"
        kubectl top pods -n eduplatform 2>/dev/null || echo "Pod metrics not available"